<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pluviômetro Digital</title>
    
    <!-- Link para o Manifesto (Essencial para instalar) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ícone para navegador (Favicon) -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1163/1163624.png">
    
    <!-- Cor do tema para a barra de status do celular -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Dependências do React -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        input, button, select { font-size: 16px; } 
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            CloudRain, Thermometer, MapPin, AlertTriangle, BarChart3, 
            History, Save, Trash2, Wind, CloudLightning, Droplets, 
            Menu, X, Search, Download 
        } from 'lucide-react';

        // --- DADOS SIMULADOS ---
        const MOCK_HISTORICAL_DATA = {
            1: { rain: 180, temp: 28, risk: "Enchentes" },
            2: { rain: 150, temp: 28, risk: "Tempestades Elétricas" },
            3: { rain: 120, temp: 26, risk: null },
            4: { rain: 90, temp: 24, risk: null },
            5: { rain: 80, temp: 20, risk: "Vendavais" },
            6: { rain: 60, temp: 18, risk: "Geada" },
            7: { rain: 70, temp: 17, risk: "Geada/Granizo" },
            8: { rain: 80, temp: 19, risk: "Ventos Fortes" },
            9: { rain: 110, temp: 21, risk: "Granizo" },
            10: { rain: 140, temp: 23, risk: "Tornados/Vendavais" },
            11: { rain: 130, temp: 25, risk: null },
            12: { rain: 160, temp: 27, risk: "Enchentes Relâmpago" },
        };

        const PHENOMENA_OPTIONS = [
            { id: 'none', label: 'Nenhum', icon: null },
            { id: 'gale', label: 'Vendaval', icon: Wind },
            { id: 'hail', label: 'Granizo', icon: CloudRain },
            { id: 'tornado', label: 'Tornado', icon: AlertTriangle },
            { id: 'flood', label: 'Enchente', icon: Droplets },
            { id: 'storm', label: 'Tempestade', icon: CloudLightning },
        ];

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ type, text }) => (
            <span className={`px-2 py-1 rounded-full text-xs font-medium border ${
                type === 'danger' ? "bg-red-100 text-red-700 border-red-200" : 
                type === 'warning' ? "bg-amber-100 text-amber-700 border-amber-200" : 
                "bg-slate-100 text-slate-700 border-slate-200"
            }`}>
                {text}
            </span>
        );

        // --- APP PRINCIPAL ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [entries, setEntries] = useState([]);
            const [locationData, setLocationData] = useState({ cep: '', city: '', uf: '', address: '' });
            const [cepInput, setCepInput] = useState('');
            const [loadingCep, setLoadingCep] = useState(false);
            const [menuOpen, setMenuOpen] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().split(' ')[0].slice(0, 5),
                rain: '',
                temp: '',
                phenomena: 'none',
                notes: ''
            });

            useEffect(() => {
                const savedEntries = localStorage.getItem('pluviometro_entries');
                const savedLocation = localStorage.getItem('pluviometro_location');
                if (savedEntries) setEntries(JSON.parse(savedEntries));
                if (savedLocation) {
                    const parsedLoc = JSON.parse(savedLocation);
                    setLocationData(parsedLoc);
                    setCepInput(parsedLoc.cep);
                }

                // PWA Install Logic
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }, []);

            useEffect(() => {
                localStorage.setItem('pluviometro_entries', JSON.stringify(entries));
            }, [entries]);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') setDeferredPrompt(null);
                setMenuOpen(false);
            };

            const handleCepSearch = async () => {
                if (cepInput.length !== 8) { alert("Digite um CEP válido."); return; }
                setLoadingCep(true);
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cepInput}/json/`);
                    const data = await response.json();
                    if (data.erro) { alert("CEP não encontrado."); } else {
                        const newLocation = { cep: cepInput, city: data.localidade, uf: data.uf, address: data.logradouro };
                        setLocationData(newLocation);
                        localStorage.setItem('pluviometro_location', JSON.stringify(newLocation));
                    }
                } catch { alert("Erro ao buscar CEP."); } finally { setLoadingCep(false); }
            };

            const handleSubmitEntry = (e) => {
                e.preventDefault();
                if (!locationData.city) { alert("Configure sua localização primeiro."); setView('settings'); return; }
                const newEntry = {
                    id: Date.now(), ...formData,
                    rain: parseFloat(formData.rain) || 0, temp: parseFloat(formData.temp) || 0,
                    year: parseInt(formData.date.split('-')[0]), month: parseInt(formData.date.split('-')[1]),
                    location: locationData.city
                };
                setEntries([newEntry, ...entries]);
                alert("Salvo!");
                setFormData({ ...formData, rain: '', temp: '', phenomena: 'none', notes: '' });
                setView('dashboard');
            };

            const deleteEntry = (id) => { if (confirm("Excluir?")) setEntries(entries.filter(e => e.id !== id)); };

            // Cálculos rápidos
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const currentMonthData = entries.filter(e => e.month === currentMonth && e.year === currentYear);
            const totalRain = currentMonthData.reduce((acc, c) => acc + c.rain, 0).toFixed(1);
            const risk = MOCK_HISTORICAL_DATA[currentMonth]?.risk;

            // Navegação e Sidebar
            const renderSidebar = () => (
                <div className={`fixed inset-y-0 left-0 transform ${menuOpen ? "translate-x-0" : "-translate-x-full"} md:relative md:translate-x-0 transition duration-200 z-30 w-64 bg-slate-800 text-white p-6 shadow-xl md:shadow-none flex flex-col h-full`}>
                    <div className="flex justify-between mb-8"><h1 className="text-xl font-bold flex gap-2"><CloudRain className="text-blue-400"/> Pluviômetro</h1><button onClick={()=>setMenuOpen(false)} className="md:hidden"><X/></button></div>
                    <nav className="flex-1 space-y-2">
                        {[
                            {id:'dashboard', icon:BarChart3, l:'Dashboard'},
                            {id:'entry', icon:Save, l:'Registrar'},
                            {id:'reports', icon:History, l:'Relatórios'},
                            {id:'settings', icon:MapPin, l:'Configuração'}
                        ].map(i=><button key={i.id} onClick={()=>{setView(i.id);setMenuOpen(false)}} className={`w-full text-left px-4 py-3 rounded-lg flex gap-3 ${view===i.id?'bg-blue-600':'hover:bg-slate-700'}`}><i.icon size={20}/> {i.l}</button>)}
                        
                        {deferredPrompt && (
                            <button onClick={handleInstallClick} className="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 mt-4 bg-green-600 text-white animate-pulse">
                                <Download size={20} /> Instalar App
                            </button>
                        )}
                    </nav>
                    {locationData.city && <div className="mt-auto pt-4 border-t border-slate-700 text-xs text-slate-400"><p className="uppercase font-bold">Local</p>{locationData.city}/{locationData.uf}</div>}
                </div>
            );

            const renderDashboard = () => (
                 <div className="space-y-4 pb-20 md:pb-0">
                    <Card className="p-5 border-l-4 border-blue-500 bg-gradient-to-br from-white to-blue-50">
                        <div className="flex justify-between"><div><p className="text-sm text-slate-500 font-medium">Chuva (Mês)</p><h3 className="text-3xl font-bold text-slate-800">{totalRain} <span className="text-sm font-normal">mm</span></h3></div><div className="p-2 bg-white rounded-full text-blue-500 shadow-sm"><CloudRain/></div></div>
                    </Card>
                    <Card className="p-5 border-l-4 border-amber-500">
                        <div className="flex justify-between"><div><p className="text-sm text-slate-500 font-medium">Alerta</p><h3 className="text-lg font-bold text-slate-800">{risk ? <span className="text-amber-600 flex gap-1 items-center"><AlertTriangle size={16}/> {risk}</span> : "Normal"}</h3></div></div>
                    </Card>
                    <Card><div className="p-4 border-b bg-slate-50 font-bold text-slate-700 text-sm">Últimos Registros</div>
                        {entries.slice(0,3).map(e=><div key={e.id} className="p-3 border-b flex justify-between text-sm"><span>{new Date(e.date).toLocaleDateString()}</span><span className="font-bold text-blue-600">{e.rain}mm</span></div>)}
                        {entries.length===0 && <div className="p-4 text-center text-slate-400 text-sm">Sem dados</div>}
                    </Card>
                </div>
            );

            // ... (Resto do código simplificado para o exemplo, segue a mesma lógica do anterior) ...
            
            // Render Entry
            const renderEntry = () => (
                <div className="max-w-xl mx-auto space-y-4 pb-20">
                    <Card className="p-6">
                        <h2 className="text-xl font-bold mb-4 flex gap-2"><Save className="text-blue-600"/> Registrar</h2>
                        <form onSubmit={handleSubmitEntry} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <input type="date" required className="border p-2 rounded" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})}/>
                                <input type="time" required className="border p-2 rounded" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})}/>
                            </div>
                            <input type="number" step="0.1" placeholder="Chuva (mm)" required className="w-full border p-3 rounded text-lg border-blue-300" value={formData.rain} onChange={e=>setFormData({...formData, rain:e.target.value})}/>
                            <input type="number" step="0.1" placeholder="Temp (°C)" className="w-full border p-3 rounded" value={formData.temp} onChange={e=>setFormData({...formData, temp:e.target.value})}/>
                            <div className="grid grid-cols-3 gap-2">
                                {PHENOMENA_OPTIONS.map(p=><button type="button" key={p.id} onClick={()=>setFormData({...formData, phenomena:p.id})} className={`p-2 border rounded flex flex-col items-center text-xs ${formData.phenomena===p.id?'bg-blue-50 border-blue-500 text-blue-700':''}`}>{p.icon && <p.icon size={16} className="mb-1"/>}{p.label}</button>)}
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold shadow-lg">SALVAR</button>
                        </form>
                    </Card>
                </div>
            );

            // Render Reports
            const renderReports = () => {
                const months = ["J","F","M","A","M","J","J","A","S","O","N","D"];
                const data = months.map((m,i)=>{
                   const current = entries.filter(e=>e.month===i+1 && e.year===currentYear).reduce((a,b)=>a+b.rain,0);
                   return {m, v: current, h: MOCK_HISTORICAL_DATA[i+1]?.rain||0};
                });
                const max = Math.max(...data.map(d=>Math.max(d.v, d.h)), 50);

                return (
                    <div className="pb-20 space-y-4">
                        <Card className="p-4">
                            <h3 className="font-bold mb-4">Chuva Anual</h3>
                            <div className="h-32 flex items-end gap-1">
                                {data.map((d,i)=>(
                                    <div key={i} className="flex-1 flex flex-col justify-end items-center h-full">
                                        <div className="flex items-end gap-[1px] h-full w-full justify-center">
                                            <div style={{height:`${(d.h/max)*100}%`}} className="w-1.5 bg-slate-200 rounded-t"></div>
                                            <div style={{height:`${(d.v/max)*100}%`}} className="w-1.5 bg-blue-500 rounded-t"></div>
                                        </div>
                                        <span className="text-[9px] text-slate-400 mt-1">{d.m}</span>
                                    </div>
                                ))}
                            </div>
                        </Card>
                         <Card>
                            <div className="bg-slate-50 p-3 font-bold text-sm border-b">Histórico</div>
                            {entries.sort((a,b)=>b.id-a.id).map(e=>(
                                <div key={e.id} className="p-3 border-b flex justify-between items-center text-sm">
                                    <div><div className="font-bold">{new Date(e.date).toLocaleDateString()}</div><div className="text-xs text-slate-500">{e.location}</div></div>
                                    <div className="text-right"><div className="font-bold text-blue-600">{e.rain}mm</div><button onClick={()=>deleteEntry(e.id)} className="text-red-400 text-xs"><Trash2 size={12}/></button></div>
                                </div>
                            ))}
                        </Card>
                    </div>
                );
            };
            
            // Render Settings
            const renderSettings = () => (
                <div className="max-w-xl mx-auto pb-20">
                     <Card className="p-6 space-y-4">
                        <h2 className="font-bold text-lg">Localização</h2>
                        <div className="flex gap-2">
                             <input className="border p-2 rounded flex-1" placeholder="CEP" maxLength={8} value={cepInput} onChange={e=>setCepInput(e.target.value.replace(/\D/g,''))}/>
                             <button onClick={handleCepSearch} className="bg-blue-600 text-white p-2 rounded w-12 flex items-center justify-center">{loadingCep?'...':<Search/>}</button>
                        </div>
                        {locationData.city && <div className="bg-slate-50 p-3 rounded border"><p className="font-bold">{locationData.city} - {locationData.uf}</p><p className="text-sm">{locationData.address}</p></div>}
                        {locationData.city && <div className="h-40 bg-slate-200 rounded overflow-hidden"><iframe width="100%" height="100%" src={`https://maps.google.com/maps?q=${encodeURIComponent(locationData.city + ',' + locationData.uf)}&t=&z=13&ie=UTF8&iwloc=&output=embed`} frameBorder="0"></iframe></div>}
                     </Card>
                </div>
            );

            return (
                <div className="flex min-h-screen bg-slate-100 font-sans text-slate-900 flex-col md:flex-row">
                    {menuOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={()=>setMenuOpen(false)}></div>}
                    {renderSidebar()}
                    <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
                        <header className="md:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm"><h1 className="font-bold flex gap-2"><CloudRain className="text-blue-500"/> Pluviômetro</h1><button onClick={()=>setMenuOpen(true)}><Menu/></button></header>
                        <main className="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full">
                            {view === 'dashboard' && renderDashboard()}
                            {view === 'entry' && renderEntry()}
                            {view === 'reports' && renderReports()}
                            {view === 'settings' && renderSettings()}
                        </main>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>